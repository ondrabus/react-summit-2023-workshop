---
import { PortableText } from "@rshackleton/astro-portabletext"
import { deliveryClient } from "../lib/kontent";
import { DestinationModel, contentTypes } from "../models";
import { nodeParse, transformToPortableText } from "@kontent-ai/rich-text-resolver"
import CTA from "./CTA.astro";
import { IContentItem, IContentItemElements } from "@kontent-ai/delivery-sdk";
import { PortableTextAstroContext } from "@rshackleton/astro-portabletext/src/ptTypes";

const destinations = await deliveryClient
    .items<DestinationModel>()
    .type(contentTypes.destination.codename)
    .depthParameter(2)
    .toPromise()

const transformLinkedItemsToGlobalContext = (linkedItems: IContentItem<IContentItemElements>[]): PortableTextAstroContext => 
    linkedItems.reduce((obj, item) => {
        obj[item.system.codename] = item;
        return obj;
    }, {})
    
---

<div class="container">
    <h1>Our destinations</h1>
    <hr />
    <ul>
        {destinations.data.items.map(destination => (
            <li>
                <img src={destination.elements.photo.value[0].url} alt={destination.elements.photo.value[0].description} />
                <h2>{destination.elements.title.value}</h2>
                <PortableText
                    components={{
                        types: {
                            ["component"]: CTA,
                        }
                    }}
                    context={transformLinkedItemsToGlobalContext(destination.elements.text.linkedItems)}
                    value={transformToPortableText(nodeParse(destination.elements.text.value))}
                    />
            </li>
        ))}
    </ul>

</div>

<style lang="sass">
ul, li
    list-style-type: none
    margin: 0
    padding: 0

ul
    flex-direction: row
    display: flex
    gap: 20px
    margin: 40px 0

li
    flex-basis: 0
    flex-grow: 1
    border: 1px solid #d7d7d7
    padding: 20px 0 15px

img
    width: 100%

h2
    font-family: 'Roboto Condensed', sans-serif
    font-size: 1.3rem
    font-weight: 700
    text-align: left
    margin: 10px
</style>

<style lang="sass" is:global>
p
    text-align: left
    font-size: .9rem
    font-family: Roboto, sans-serif
    margin: 10px
</style>